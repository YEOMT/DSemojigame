<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì´ëª¨ì§€ ê°•í™”í•˜ê¸° ğŸŒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Jua', sans-serif;
            background-color: #1a1a2e;
            color: #fff;
            overflow-x: hidden;
            touch-action: manipulation;
        }
        
        @keyframes flash {
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); transform: scale(1); }
            50% { box-shadow: 0 0 50px 20px rgba(255, 255, 255, 0); transform: scale(1.1); }
            100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); transform: scale(1); }
        }

        @keyframes critical-flash {
            0% { box-shadow: 0 0 0 0 rgba(255, 200, 0, 0.7); transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.2) rotate(-5deg); }
            50% { box-shadow: 0 0 80px 40px rgba(255, 200, 0, 0.5); transform: scale(1.2) rotate(5deg); }
            100% { box-shadow: 0 0 0 0 rgba(255, 200, 0, 0); transform: scale(1) rotate(0deg); }
        }

        @keyframes super-critical-flash {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 255, 0.7); transform: scale(1); filter: hue-rotate(0deg); }
            50% { box-shadow: 0 0 100px 60px rgba(255, 0, 255, 0.5); transform: scale(1.3); filter: hue-rotate(180deg); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 255, 0); transform: scale(1); filter: hue-rotate(360deg); }
        }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(1.5); }
        }

        .animate-flash { animation: flash 0.3s ease-out; }
        .animate-critical { animation: critical-flash 0.5s ease-out; }
        .animate-super-critical { animation: super-critical-flash 0.8s ease-out; }
        .animate-shake { animation: shake 0.5s; }

        .emoji-display { transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        .modal-bg { background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px); }
        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
        }

        .floating-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            font-weight: bold;
            text-shadow: 2px 2px 0 #000;
            z-index: 50;
            animation: floatUp 1s forwards;
            white-space: nowrap;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Loading Overlay -->
    <div id="serverLoading" class="fixed inset-0 z-[60] bg-black/80 flex flex-col items-center justify-center text-center p-4">
        <div class="loader mb-4 mx-auto" style="width: 40px; height: 40px;"></div>
        <p class="text-yellow-400">ì‹œìŠ¤í…œ ì—°ê²° ì¤‘...</p>
    </div>

    <!-- Start Screen -->
    <div id="startScreen" class="w-full max-w-md text-center space-y-6 hidden">
        <h1 class="text-5xl text-yellow-400 drop-shadow-lg mb-2">ì´ëª¨ì§€ ê°•í™”í•˜ê¸°</h1>
        <div id="connectionStatus" class="inline-block px-3 py-1 rounded-full text-xs font-bold bg-gray-700 text-gray-400 mb-2">
            âšª ì˜¤í”„ë¼ì¸ ëª¨ë“œ
        </div>
        <p class="text-gray-400 text-lg">0ë‹¨ê³„ ë¨¼ì§€ë¶€í„° 50ë‹¨ê³„ ìš°ì£¼ê¹Œì§€!</p>
        
        <div class="glass-panel p-6 space-y-4">
            <div class="text-6xl animate-bounce">âš’ï¸</div>
            <p class="text-sm text-gray-300">
                <span class="text-red-400 font-bold">New!</span> ìš´ì´ ì¢‹ìœ¼ë©´ 2~3ë‹¨ê³„ ì í”„!<br>
                <span id="modeDesc">ë¡œì»¬ì— ê¸°ë¡ì´ ì €ì¥ë©ë‹ˆë‹¤.</span>
            </p>
            <input type="text" id="playerNameInput" placeholder="ë‹‰ë„¤ì„ (ìµœëŒ€ 8ê¸€ì)" maxlength="8" 
                class="w-full p-3 rounded-lg bg-gray-800 border border-gray-600 text-center text-xl focus:outline-none focus:border-yellow-500 transition-colors">
            <button onclick="window.startGame()" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 py-4 rounded-xl text-2xl font-bold shadow-lg hover:scale-105 transition-transform active:scale-95">
                ë„ì „ ì‹œì‘!
            </button>
        </div>

        <div class="glass-panel p-4 relative">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-xl text-yellow-300">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹ Top 10</h3>
                <div class="flex items-center gap-1 text-xs text-gray-400">
                    <div id="statusDot" class="w-2 h-2 rounded-full bg-gray-500"></div> <span id="statusText">ë¡œì»¬</span>
                </div>
            </div>
            <div id="startLeaderboardList" class="space-y-2 text-sm min-h-[100px]">
                <div class="text-gray-500 py-4">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="hidden w-full max-w-md flex flex-col items-center relative">
        <div class="w-full flex justify-between items-center mb-6 glass-panel p-3 px-5">
            <div class="text-gray-400">í”Œë ˆì´ì–´: <span id="displayPlayerName" class="text-white font-bold"></span></div>
            <div class="text-gray-400">í˜„ì¬ í™•ë¥ : <span id="currentChance" class="text-green-400 font-bold">99%</span></div>
        </div>

        <div id="cardArea" class="w-full bg-gradient-to-b from-gray-800 to-gray-900 rounded-3xl p-8 shadow-2xl border-4 border-gray-700 text-center relative overflow-hidden mb-6">
            <div class="absolute top-0 left-0 w-full h-2 bg-gray-700">
                <div id="progressBar" class="h-full bg-yellow-500 transition-all duration-500" style="width: 0%"></div>
            </div>
            
            <div class="mt-4 mb-2 text-gray-400 font-bold tracking-widest text-sm">LEVEL <span id="levelDisplay" class="text-2xl text-white">0</span></div>
            
            <div id="emojiDisplay" class="emoji-display text-[120px] leading-tight my-4 drop-shadow-2xl select-none">
                â˜ï¸
            </div>
            
            <div id="nameDisplay" class="text-3xl font-bold text-white mb-2 drop-shadow-md">ë¨¼ì§€</div>
            <div id="descDisplay" class="text-sm text-gray-500">ì•„ë¬´ëŸ° ê°€ì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>

        <div class="w-full grid grid-cols-2 gap-4">
            <button onclick="window.stopGame()" class="bg-gray-700 hover:bg-gray-600 text-gray-200 py-4 rounded-2xl font-bold text-xl shadow-lg transform transition active:scale-95 border-b-4 border-gray-900">
                âœ‹ ë©ˆì¶”ê¸°<br><span class="text-xs font-normal text-gray-400">ê¸°ë¡ ì €ì¥</span>
            </button>
            <button id="upgradeBtn" onclick="window.attemptUpgrade()" class="bg-gradient-to-b from-red-500 to-red-700 hover:from-red-400 hover:to-red-600 text-white py-4 rounded-2xl font-bold text-xl shadow-lg transform transition active:scale-95 border-b-4 border-red-900 relative overflow-hidden">
                <span class="relative z-10">ğŸ”¨ ê°•í™”í•˜ê¸°</span>
            </button>
        </div>

        <div id="gameLog" class="w-full mt-6 h-32 overflow-y-auto text-sm text-gray-400 space-y-1 p-2 scrollbar-hide text-center font-sans opacity-70">
            <div class="italic">ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="resultModal" class="hidden fixed inset-0 modal-bg flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 border-2 border-gray-600 w-full max-w-sm rounded-2xl p-6 text-center shadow-2xl transform scale-100 transition-transform">
            <div id="resultIcon" class="text-6xl mb-4">ğŸ’¥</div>
            <h2 id="resultTitle" class="text-3xl font-bold mb-2">ê°•í™” ì‹¤íŒ¨!</h2>
            <p id="resultDesc" class="text-gray-300 mb-6">ì•„ì‰½ê²Œë„ ì•„ì´í…œì´ íŒŒê´´ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            
            <div class="bg-gray-900 rounded-lg p-4 mb-6">
                <div class="flex justify-between text-sm text-gray-400 mb-1">
                    <span>ìµœì¢… ë ˆë²¨</span>
                    <span>ê¸°ë¡ ì €ì¥</span>
                </div>
                <div class="flex justify-between items-end">
                    <span id="resultLevel" class="text-2xl text-yellow-400 font-bold">Lv. 12</span>
                    <span id="resultSaved" class="text-red-400 font-bold">ì‹¤íŒ¨ (ì €ì¥ ì•ˆë¨)</span>
                </div>
            </div>

            <button onclick="window.resetGame()" class="w-full bg-white text-gray-900 py-3 rounded-xl font-bold text-lg hover:bg-gray-200 transition">
                ë‹¤ì‹œ ë„ì „í•˜ê¸°
            </button>
        </div>
    </div>

    <!-- Leaderboard Modal (In Game) -->
    <div id="leaderboardSection" class="hidden w-full max-w-md mt-10">
        <div class="glass-panel p-5">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-yellow-400">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</h2>
                <span id="ingameStatus" class="text-xs text-gray-400">â— Local</span>
            </div>
            <div id="leaderboardList" class="space-y-3"></div>
        </div>
    </div>

    <!-- Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- System State ---
        let isOnline = false;
        let db = null;
        let auth = null;
        let currentUser = null;
        const LOCAL_STORAGE_KEY = 'emoji_upgrade_local_v2';
        const APP_ID = 'default-app-id'; // Fallback

        // --- Init Function ---
        async function initSystem() {
            try {
                // Check if we are in the Preview Environment (variables exist)
                if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    const firebaseConfig = JSON.parse(__firebase_config);
                    const app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    
                    // Auth Flow
                    let authSuccess = false;
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        try {
                            await signInWithCustomToken(auth, __initial_auth_token);
                            authSuccess = true;
                        } catch(e) { console.warn("Custom token failed", e); }
                    }

                    if (!authSuccess) {
                        await signInAnonymously(auth);
                    }
                    
                    currentUser = auth.currentUser;
                    isOnline = true;
                    console.log("Online Mode Activated");
                    
                    // Start Listener
                    listenToLeaderboard();
                } else {
                    throw new Error("Local Environment Detected");
                }
            } catch (error) {
                console.log("Switching to Offline Mode:", error.message);
                isOnline = false;
                // Offline Listener (Local Storage)
                renderLocalLeaderboard();
            }

            // Update UI for Mode
            updateModeUI();
            
            // Hide Loader & Show Screen
            document.getElementById('serverLoading').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
        }

        function updateModeUI() {
            const statusBadge = document.getElementById('connectionStatus');
            const modeDesc = document.getElementById('modeDesc');
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const ingameStatus = document.getElementById('ingameStatus');

            if (isOnline) {
                statusBadge.innerHTML = 'ğŸŸ¢ ì˜¨ë¼ì¸ ëª¨ë“œ';
                statusBadge.className = 'inline-block px-3 py-1 rounded-full text-xs font-bold bg-green-900 text-green-400 mb-2';
                modeDesc.innerText = "ëª¨ë“  í”Œë ˆì´ì–´ì™€ ë­í‚¹ì„ ê³µìœ í•©ë‹ˆë‹¤.";
                statusDot.className = "w-2 h-2 rounded-full bg-green-500 animate-pulse";
                statusText.innerText = "ì‹¤ì‹œê°„";
                statusText.className = "text-green-400";
                ingameStatus.innerText = "â— Live Global";
                ingameStatus.className = "text-xs text-green-400";
            } else {
                statusBadge.innerHTML = 'âšª ì˜¤í”„ë¼ì¸ ëª¨ë“œ';
                statusBadge.className = 'inline-block px-3 py-1 rounded-full text-xs font-bold bg-gray-700 text-gray-300 mb-2';
                modeDesc.innerText = "ê¸°ë¡ì´ ë‚´ ì»´í“¨í„°ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.";
                statusDot.className = "w-2 h-2 rounded-full bg-gray-500";
                statusText.innerText = "ë¡œì»¬";
                statusText.className = "text-gray-400";
                ingameStatus.innerText = "â— Local Only";
                ingameStatus.className = "text-xs text-gray-400";
            }
        }

        // --- Leaderboard Logic (Hybrid) ---
        function listenToLeaderboard() {
            if (!isOnline) {
                renderLocalLeaderboard();
                return;
            }

            const appId = typeof __app_id !== 'undefined' ? __app_id : APP_ID;
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'emoji_rankings_v2');
            
            onSnapshot(colRef, (snapshot) => {
                const rankings = [];
                snapshot.forEach(doc => rankings.push(doc.data()));
                rankings.sort((a, b) => b.level - a.level);
                renderLeaderboardUI(rankings);
            }, (error) => {
                console.error("Fetch Error, fallback to local", error);
                isOnline = false;
                updateModeUI();
                renderLocalLeaderboard();
            });
        }

        function renderLocalLeaderboard() {
            const localData = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
            localData.sort((a, b) => b.level - a.level);
            renderLeaderboardUI(localData);
        }

        function renderLeaderboardUI(rankings) {
            [document.getElementById('startLeaderboardList'), document.getElementById('leaderboardList')].forEach(container => {
                if (!container) return;
                container.innerHTML = "";
                
                const displayList = rankings.slice(0, 10);
                if (displayList.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-2">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }

                displayList.forEach((rank, index) => {
                    const isTop = index < 3;
                    const rowClass = isTop ? 'bg-gray-700/50 border-yellow-500/30' : 'bg-gray-800/30 border-gray-700';
                    const rankBadge = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}ìœ„`;
                    const isMe = rank.name === playerName;
                    const nameClass = isMe ? "text-yellow-300 font-bold" : "text-white font-bold";
                    
                    container.innerHTML += `
                        <div class="flex items-center justify-between p-2 rounded-lg border ${rowClass}">
                            <div class="flex items-center gap-3">
                                <span class="font-bold w-8 text-center text-yellow-500">${rankBadge}</span>
                                <div class="flex flex-col">
                                    <span class="${nameClass}">${rank.name}</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xl">${rank.emoji}</div>
                                <div class="text-xs text-yellow-300 font-bold">Lv.${rank.level} ${rank.item}</div>
                            </div>
                        </div>
                    `;
                });
            });
        }

        async function saveScore(level, name, item, emoji) {
            const data = {
                name, level, item, emoji,
                timestamp: Date.now()
            };

            if (isOnline && currentUser) {
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : APP_ID;
                    const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'emoji_rankings_v2');
                    await addDoc(colRef, { ...data, uid: currentUser.uid });
                    return true;
                } catch (e) {
                    console.error("Online save failed, trying local", e);
                }
            }

            // Local Save Fallback
            const localData = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
            localData.push(data);
            localData.sort((a, b) => b.level - a.level);
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(localData.slice(0, 50))); // Keep top 50 locally
            
            // Re-render immediately if offline
            if (!isOnline) renderLocalLeaderboard();
            
            return true;
        }

        // --- Game Data & Logic ---
        const GAME_DATA = [
            { lv: 0, name: "ë¨¼ì§€", emoji: "ğŸŒ«ï¸", prob: 99, desc: "í›„~ ë¶ˆë©´ ë‚ ì•„ê°‘ë‹ˆë‹¤." },
            { lv: 1, name: "ëŒë§¹ì´", emoji: "ğŸª¨", prob: 98, desc: "ê¸¸ê°€ì— í”í•œ ëŒì…ë‹ˆë‹¤." },
            { lv: 2, name: "ì¡°ì•½ëŒ", emoji: "ğŸŒ‘", prob: 97, desc: "ì¡°ê¸ˆ ë§¤ë„ëŸ¬ì›Œì¡ŒìŠµë‹ˆë‹¤." },
            { lv: 3, name: "ë²½ëŒ", emoji: "ğŸ§±", prob: 96, desc: "ê±´ì¶• ìì¬ë¡œ ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤." },
            { lv: 4, name: "ë™ì „", emoji: "ğŸª™", prob: 95, desc: "ì§¤ë‘ì§¤ë‘ ì†Œë¦¬ê°€ ë‚©ë‹ˆë‹¤." },
            { lv: 5, name: "ë…¹ìŠ¨ ë‹¨ê²€", emoji: "ğŸ—¡ï¸", prob: 94, desc: "íŒŒìƒí’ì„ ì¡°ì‹¬í•˜ì„¸ìš”." },
            { lv: 6, name: "ë§ì¹˜", emoji: "ğŸ”¨", prob: 92, desc: "ëª»ì„ ë°•ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤." },
            { lv: 7, name: "ë„ë¼", emoji: "ğŸª“", prob: 90, desc: "ë‚˜ë¬´ë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." },
            { lv: 8, name: "ì² ê²€", emoji: "âš”ï¸", prob: 85, desc: "ê¸°ë³¸ì ì¸ ë¬´ê¸°ì…ë‹ˆë‹¤." },
            { lv: 9, name: "ë°©íŒ¨", emoji: "ğŸ›¡ï¸", prob: 80, desc: "ê³µê²©ì„ ë§‰ì•„ëƒ…ë‹ˆë‹¤." }, 
            { lv: 10, name: "ì€ìˆ˜ì €", emoji: "ğŸ¥„", prob: 75, desc: "ìš´ì´ ì¡°ê¸ˆ í•„ìš”í•©ë‹ˆë‹¤." },
            { lv: 11, name: "ê¸ˆë°˜ì§€", emoji: "ğŸ’", prob: 70, desc: "ë°˜ì§ì´ê¸° ì‹œì‘í•©ë‹ˆë‹¤." },
            { lv: 12, name: "ë£¨ë¹„", emoji: "ğŸ”´", prob: 65, desc: "ë¶‰ì€ ë¹›ì´ ì˜ë¡±í•©ë‹ˆë‹¤." },
            { lv: 13, name: "ì‚¬íŒŒì´ì–´", emoji: "ğŸ”µ", prob: 60, desc: "í‘¸ë¥¸ ë°”ë‹¤ì˜ ìƒ‰ì…ë‹ˆë‹¤." },
            { lv: 14, name: "ì—ë©”ë„ë“œ", emoji: "ğŸŸ¢", prob: 55, desc: "ìˆ²ì˜ ê¸°ìš´ì´ ëŠê»´ì§‘ë‹ˆë‹¤." },
            { lv: 15, name: "ë‹¤ì´ì•„ëª¬ë“œ", emoji: "ğŸ’", prob: 50, desc: "ê°€ì¥ ë‹¨ë‹¨í•œ ë³´ì„ì…ë‹ˆë‹¤." }, 
            { lv: 16, name: "ë³´ë¬¼ìƒì", emoji: "âš±ï¸", prob: 45, desc: "ë¬´ì—‡ì´ ë“¤ì—ˆì„ê¹Œìš”?" },
            { lv: 17, name: "ì™•ê´€", emoji: "ğŸ‘‘", prob: 40, desc: "ê¶Œë ¥ì˜ ìƒì§•ì…ë‹ˆë‹¤." },
            { lv: 18, name: "ë§ˆë²•ë´‰", emoji: "ğŸª„", prob: 35, desc: "ì‹ ë¹„í•œ í˜ì´ ê¹ƒë“¤ì—ˆìŠµë‹ˆë‹¤." },
            { lv: 19, name: "ìœ ë ¹", emoji: "ğŸ‘»", prob: 30, desc: "ì´ìŠ¹ì„ ë– ëŒê³  ìˆìŠµë‹ˆë‹¤." },
            { lv: 20, name: "ë„ê¹¨ë¹„ë¶ˆ", emoji: "ğŸ”¥", prob: 25, desc: "ëœ¨ê²ì§€ ì•Šì€ ë¶ˆê½ƒì…ë‹ˆë‹¤." },
            { lv: 21, name: "ìœ ë‹ˆì½˜", emoji: "ğŸ¦„", prob: 20, desc: "ì „ì„¤ ì†ì˜ ë™ë¬¼ì…ë‹ˆë‹¤." },
            { lv: 22, name: "ìš©", emoji: "ğŸ‰", prob: 18, desc: "í•˜ëŠ˜ì„ ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤." },
            { lv: 23, name: "ë¶ˆì‚¬ì¡°", emoji: "ğŸ¦…", prob: 16, desc: "ì£½ì§€ ì•ŠëŠ” ìƒˆì…ë‹ˆë‹¤." },
            { lv: 24, name: "ì²œì‚¬", emoji: "ğŸ‘¼", prob: 14, desc: "ì„±ìŠ¤ëŸ¬ìš´ ì¡´ì¬ì…ë‹ˆë‹¤." },
            { lv: 25, name: "ì•…ë§ˆ", emoji: "ğŸ˜ˆ", prob: 12, desc: "ìœ í˜¹ì„ ì¡°ì‹¬í•˜ì„¸ìš”." },
            { lv: 26, name: "ì™¸ê³„ì¸", emoji: "ğŸ‘½", prob: 11, desc: "ìš°ì£¼ì—ì„œ ì™”ìŠµë‹ˆë‹¤." },
            { lv: 27, name: "UFO", emoji: "ğŸ›¸", prob: 10, desc: "ë¯¸í™•ì¸ ë¹„í–‰ ë¬¼ì²´ì…ë‹ˆë‹¤." },
            { lv: 28, name: "ì¸ê³µìœ„ì„±", emoji: "ğŸ›°ï¸", prob: 9, desc: "ì§€êµ¬ë¥¼ ê°ì‹œí•©ë‹ˆë‹¤." },
            { lv: 29, name: "ë¡œì¼“", emoji: "ğŸš€", prob: 8, desc: "ëŒ€ê¸°ê¶Œì„ ëŒíŒŒí•©ë‹ˆë‹¤." }, 
            { lv: 30, name: "ë‹¬", emoji: "ğŸŒ™", prob: 7, desc: "í† ë¼ê°€ ì‚´ê³  ìˆìŠµë‹ˆë‹¤." },
            { lv: 31, name: "ì§€êµ¬", emoji: "ğŸŒ", prob: 6, desc: "ìš°ë¦¬ì˜ ê³ í–¥ì…ë‹ˆë‹¤." },
            { lv: 32, name: "íƒœì–‘", emoji: "â˜€ï¸", prob: 5, desc: "ëª¨ë“  ìƒëª…ì˜ ê·¼ì›ì…ë‹ˆë‹¤." },
            { lv: 33, name: "í˜œì„±", emoji: "â˜„ï¸", prob: 4, desc: "ê¼¬ë¦¬ê°€ ì•„ë¦„ë‹µìŠµë‹ˆë‹¤." },
            { lv: 34, name: "í† ì„±", emoji: "ğŸª", prob: 3, desc: "ì•„ë¦„ë‹¤ìš´ ê³ ë¦¬ë¥¼ ê°€ì¡ŒìŠµë‹ˆë‹¤." },
            { lv: 35, name: "ì€í•˜ìˆ˜", emoji: "ğŸŒŒ", prob: 2.5, desc: "ë³„ë“¤ì˜ ê°•ì…ë‹ˆë‹¤." },
            { lv: 36, name: "ë¸”ë™í™€", emoji: "âš«", prob: 2.0, desc: "ë¹›ì¡°ì°¨ ë¹ ì ¸ë‚˜ê°ˆ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." },
            { lv: 37, name: "ì´ˆì‹ ì„±", emoji: "ğŸ’¥", prob: 1.8, desc: "ë³„ì˜ ë§ˆì§€ë§‰ í­ë°œì…ë‹ˆë‹¤." },
            { lv: 38, name: "ì„±ìš´", emoji: "ğŸŒ«ï¸", prob: 1.6, desc: "ë³„ë“¤ì´ íƒœì–´ë‚˜ëŠ” ê³³ì…ë‹ˆë‹¤." },
            { lv: 39, name: "í€˜ì´ì‚¬", emoji: "âœ¨", prob: 1.4, desc: "ìš°ì£¼ì—ì„œ ê°€ì¥ ë°ì€ ì²œì²´ì…ë‹ˆë‹¤." },
            { lv: 40, name: "ì°¨ì›ì˜ ë¬¸", emoji: "ğŸšª", prob: 1.2, desc: "ì–´ë””ë¡œ ì—°ê²°ë ì§€ ëª¨ë¦…ë‹ˆë‹¤." },
            { lv: 41, name: "ì‹œê°„", emoji: "â³", prob: 1.0, desc: "ëˆ„êµ¬ë„ ê±°ìŠ¤ë¥¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." },
            { lv: 42, name: "ê³µê°„", emoji: "ğŸ’ ", prob: 0.8, desc: "ë¬´í•œíˆ í¼ì³ì ¸ ìˆìŠµë‹ˆë‹¤." },
            { lv: 43, name: "ë¹›", emoji: "ğŸ’¡", prob: 0.6, desc: "ê°€ì¥ ë¹ ë¥¸ ì¡´ì¬ì…ë‹ˆë‹¤." },
            { lv: 44, name: "ì–´ë‘ ", emoji: "ğŸŒ‘", prob: 0.5, desc: "ë¹›ì´ ì—†ëŠ” ê³³ì…ë‹ˆë‹¤." },
            { lv: 45, name: "í˜¼ëˆ", emoji: "ğŸŒ€", prob: 0.4, desc: "ì§ˆì„œê°€ ë¬´ë„ˆì§„ ìƒíƒœì…ë‹ˆë‹¤." },
            { lv: 46, name: "ì§ˆì„œ", emoji: "âš–ï¸", prob: 0.3, desc: "ëª¨ë“  ê²ƒì´ ì œìë¦¬ì— ìˆìŠµë‹ˆë‹¤." },
            { lv: 47, name: "ìƒëª…", emoji: "ğŸ§¬", prob: 0.2, desc: "ê¸°ì  ê·¸ ìì²´ì…ë‹ˆë‹¤." },
            { lv: 48, name: "ì£½ìŒ", emoji: "ğŸ’€", prob: 0.1, desc: "í”¼í•  ìˆ˜ ì—†ëŠ” ìš´ëª…ì…ë‹ˆë‹¤." },
            { lv: 49, name: "ì‹ ", emoji: "ğŸ›", prob: 0.05, desc: "ì „ì§€ì „ëŠ¥í•œ ì¡´ì¬ì…ë‹ˆë‹¤." },
            { lv: 50, name: "ìš°ì£¼ì˜ ì„­ë¦¬", emoji: "âš›ï¸", prob: 0, desc: "ì¡´ì¬í•˜ëŠ” ëª¨ë“  ê²ƒì˜ ì´ìœ ." }
        ];

        let currentLevel = 0;
        let playerName = "";
        let isProcessing = false;

        const els = {
            startScreen: document.getElementById('startScreen'),
            gameScreen: document.getElementById('gameScreen'),
            nameInput: document.getElementById('playerNameInput'),
            displayName: document.getElementById('displayPlayerName'),
            currentChance: document.getElementById('currentChance'),
            cardArea: document.getElementById('cardArea'),
            levelDisplay: document.getElementById('levelDisplay'),
            emojiDisplay: document.getElementById('emojiDisplay'),
            nameDisplay: document.getElementById('nameDisplay'),
            descDisplay: document.getElementById('descDisplay'),
            progressBar: document.getElementById('progressBar'),
            gameLog: document.getElementById('gameLog'),
            resultModal: document.getElementById('resultModal'),
            resultIcon: document.getElementById('resultIcon'),
            resultTitle: document.getElementById('resultTitle'),
            resultDesc: document.getElementById('resultDesc'),
            resultLevel: document.getElementById('resultLevel'),
            resultSaved: document.getElementById('resultSaved'),
            leaderboardSection: document.getElementById('leaderboardSection'),
            leaderboardList: document.getElementById('leaderboardList'),
            startLeaderboardList: document.getElementById('startLeaderboardList')
        };
        
        window.startGame = function() {
            const name = els.nameInput.value.trim();
            if (!name) {
                alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }
            playerName = name;
            currentLevel = 0;
            isProcessing = false;
            
            updateUI();
            addLog("ê²Œì„ì„ ì‹œì‘í•©ë‹ˆë‹¤. í–‰ìš´ì„ ë¹•ë‹ˆë‹¤!");
            
            els.startScreen.classList.add('hidden');
            els.gameScreen.classList.remove('hidden');
            els.leaderboardSection.classList.remove('hidden');
        };

        window.attemptUpgrade = function() {
            if (isProcessing) return;
            if (currentLevel >= 50) return;

            isProcessing = true;
            const currentData = GAME_DATA[currentLevel];
            const prob = currentData.prob;

            const btn = document.getElementById('upgradeBtn');
            btn.classList.add('scale-95', 'brightness-75');
            addLog(`ê°•í™” ì‹œë„ ì¤‘... (í™•ë¥ : ${prob}%)`);

            setTimeout(() => {
                btn.classList.remove('scale-95', 'brightness-75');
                const roll = Math.random() * 100;
                
                if (roll < prob) {
                    if (roll < (prob / 4)) success(3);
                    else if (roll < (prob / 2)) success(2);
                    else success(1);
                } else {
                    fail();
                }
                isProcessing = false;
            }, 600);
        };

        function success(increment) {
            const prevLevel = currentLevel;
            currentLevel = Math.min(currentLevel + increment, 50);
            const actualIncrement = currentLevel - prevLevel;
            const data = GAME_DATA[currentLevel];
            
            if (increment === 3 && actualIncrement >= 3) {
                addLog(`âš¡ ì´ˆëŒ€ë°• í¬ë¦¬í‹°ì»¬!!! +3ë‹¨ê³„ ìƒìŠ¹!`);
                showFloatingText("âš¡ ì´ˆëŒ€ë°• +3 âš¡", "#d946ef");
                triggerEffect('animate-super-critical');
                fireConfetti(true);
            } else if (increment === 2 && actualIncrement >= 2) {
                addLog(`ğŸ”¥ í¬ë¦¬í‹°ì»¬! +2ë‹¨ê³„ ìƒìŠ¹!`);
                showFloatingText("ğŸ”¥ í¬ë¦¬í‹°ì»¬ +2 ğŸ”¥", "#fbbf24");
                triggerEffect('animate-critical');
                fireConfetti(false);
            } else {
                addLog(`âœ… ê°•í™” ì„±ê³µ! ${data.name}(ìœ¼)ë¡œ ì§„í™”!`);
                triggerEffect('animate-flash');
            }
            
            if (increment === 1 && (currentLevel % 5 === 0 || currentLevel > 30)) {
                fireConfetti(false);
            }

            updateUI();
            if (currentLevel === 50) window.stopGame(true);
        }

        function fail() {
            addLog(`ğŸ’¥ ê°•í™” ì‹¤íŒ¨... ì•„ì´í…œì´ íŒŒê´´ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            showFloatingText("íŒŒê´´ë¨...", "#ef4444");
            triggerEffect('animate-shake');
            showResult(false);
        }

        function showFloatingText(text, color) {
            const el = document.createElement('div');
            el.className = 'floating-text text-4xl drop-shadow-lg';
            el.innerText = text;
            el.style.color = color;
            els.cardArea.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function triggerEffect(animClass) {
            els.cardArea.classList.remove('animate-flash', 'animate-critical', 'animate-super-critical', 'animate-shake');
            void els.cardArea.offsetWidth;
            els.cardArea.classList.add(animClass);
        }

        window.stopGame = function(isClear = false) {
            if (isProcessing && !isClear) return;
            if (currentLevel === 0 && !isClear) {
                alert("0ë‹¨ê³„ì—ì„œëŠ” ë©ˆì¶œ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            saveScore(currentLevel, playerName, GAME_DATA[currentLevel].name, GAME_DATA[currentLevel].emoji)
                .then(() => showResult(true, isClear));
        };

        function showResult(isSaved, isClear = false) {
            els.resultModal.classList.remove('hidden');
            if (isSaved) {
                els.resultIcon.innerText = isClear ? "ğŸ‰" : "ğŸ›‘";
                els.resultTitle.innerText = isClear ? "ê²Œì„ í´ë¦¬ì–´!" : "ê°•í™” ì¤‘ë‹¨";
                els.resultDesc.innerText = isClear ? "ì „ì„¤ì ì¸ ì—…ì ì„ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤!" : "ì•ˆì „í•˜ê²Œ ì•„ì´í…œì„ ì±™ê²¼ìŠµë‹ˆë‹¤.";
                els.resultLevel.innerText = `Lv. ${currentLevel}`;
                els.resultLevel.className = "text-2xl text-green-400 font-bold";
                els.resultSaved.innerText = isOnline ? "ì„œë²„ ì €ì¥ ì™„ë£Œ" : "ë¡œì»¬ ì €ì¥ ì™„ë£Œ";
                els.resultSaved.className = "text-green-400 font-bold";
                if (isClear) fireConfetti(true);
            } else {
                els.resultIcon.innerText = "ğŸ’¥";
                els.resultTitle.innerText = "ê°•í™” ì‹¤íŒ¨";
                els.resultDesc.innerText = "ìš•ì‹¬ì´ ê³¼í–ˆìŠµë‹ˆë‹¤.";
                els.resultLevel.innerText = `(ë„ë‹¬) Lv. ${currentLevel}`;
                els.resultLevel.className = "text-2xl text-gray-500 font-bold";
                els.resultSaved.innerText = "ì €ì¥ ë¶ˆê°€";
                els.resultSaved.className = "text-red-400 font-bold";
            }
        }

        window.resetGame = function() {
            els.resultModal.classList.add('hidden');
            els.gameScreen.classList.add('hidden');
            els.leaderboardSection.classList.add('hidden');
            els.startScreen.classList.remove('hidden');
            els.nameInput.value = "";
            els.gameLog.innerHTML = '<div class="italic">ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.</div>';
        };

        function updateUI() {
            const data = GAME_DATA[currentLevel];
            els.displayName.innerText = playerName;
            els.levelDisplay.innerText = currentLevel;
            els.emojiDisplay.innerText = data.emoji;
            els.nameDisplay.innerText = data.name;
            els.descDisplay.innerText = data.desc;
            
            if (currentLevel < 50) {
                els.currentChance.innerText = `${GAME_DATA[currentLevel].prob}%`;
                els.currentChance.className = getProbColor(GAME_DATA[currentLevel].prob);
            } else {
                els.currentChance.innerText = "-";
            }
            const progress = (currentLevel / 50) * 100;
            els.progressBar.style.width = `${progress}%`;
        }

        function addLog(msg) {
            const div = document.createElement('div');
            div.innerText = msg;
            els.gameLog.prepend(div);
        }

        function getProbColor(prob) {
            if (prob >= 80) return "text-green-400 font-bold";
            if (prob >= 50) return "text-yellow-400 font-bold";
            if (prob >= 20) return "text-orange-500 font-bold";
            return "text-red-600 font-bold animate-pulse";
        }

        function fireConfetti(isMassive = false) {
            if (isMassive) {
                const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 999 };
                const random = (min, max) => Math.random() * (max - min) + min;
                confetti({ ...defaults, particleCount: 50, origin: { x: random(0.1, 0.3), y: Math.random() - 0.2 } });
                confetti({ ...defaults, particleCount: 50, origin: { x: random(0.7, 0.9), y: Math.random() - 0.2 } });
            } else {
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            }
        }

        // Start Init
        initSystem();
    </script>
</body>
</html>