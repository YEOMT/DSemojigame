<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì´ëª¨ì§€ ê°•í™”í•˜ê¸° Live 1.9 (X-MAS) ğŸ„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Jua', sans-serif;
            background-color: #0f172a;
            color: #fff;
            overflow-x: hidden;
            touch-action: manipulation;
            /* ì„±íƒ„ì ˆ ë°¤ ë°°ê²½ ì´ë¯¸ì§€ */
            background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.7)), url('https://images.unsplash.com/photo-1543589077-47d81606c1bf?q=80&w=1000&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }
        
        /* íš¨ê³¼ ì• ë‹ˆë©”ì´ì…˜ ì •ì˜ */
        @keyframes flash {
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); transform: scale(1); }
            50% { box-shadow: 0 0 50px 20px rgba(255, 255, 255, 0); transform: scale(1.1); }
            100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); transform: scale(1); }
        }

        @keyframes critical-flash {
            0% { box-shadow: 0 0 0 0 rgba(255, 200, 0, 0.7); transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.2) rotate(-5deg); }
            50% { box-shadow: 0 0 80px 40px rgba(255, 200, 0, 0.5); transform: scale(1.2) rotate(5deg); }
            100% { box-shadow: 0 0 0 0 rgba(255, 200, 0, 0); transform: scale(1) rotate(0deg); }
        }

        @keyframes super-critical-flash {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 255, 0.7); transform: scale(1); filter: hue-rotate(0deg); }
            50% { box-shadow: 0 0 100px 60px rgba(255, 0, 255, 0.5); transform: scale(1.3); filter: hue-rotate(180deg); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 255, 0); transform: scale(1); filter: hue-rotate(360deg); }
        }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(1.5); }
        }

        /* Fever Mode Styles */
        @keyframes fever-pulse {
            0% { box-shadow: 0 0 10px #fbbf24; border-color: #fbbf24; }
            50% { box-shadow: 0 0 30px #f59e0b; border-color: #f59e0b; transform: scale(1.02); }
            100% { box-shadow: 0 0 10px #fbbf24; border-color: #fbbf24; }
        }

        .fever-active {
            animation: fever-pulse 0.5s infinite;
            background: linear-gradient(to bottom, #7f1d1d, #1a1a2e) !important; /* Red to Dark */
        }

        .animate-flash { animation: flash 0.3s ease-out; }
        .animate-critical { animation: critical-flash 0.5s ease-out; }
        .animate-super-critical { animation: super-critical-flash 0.8s ease-out; }
        .animate-shake { animation: shake 0.5s; }

        .emoji-display { transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        .modal-bg { background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px); }
        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .floating-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            font-weight: bold;
            text-shadow: 2px 2px 0 #000;
            z-index: 50;
            animation: floatUp 1s forwards;
            white-space: nowrap;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ef4444; /* Red spinner */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Server Tab Styles */
        .server-tab {
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
            opacity: 0.6;
        }
        .server-tab.active {
            opacity: 1;
            border-bottom-color: #ef4444; /* Red underline */
            color: #fca5a5; /* Light red text */
        }

        /* Decorative Font for Merry Christmas */
        .xmas-font {
            font-family: 'Mountains of Christmas', cursive;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Loading Overlay -->
    <div id="serverLoading" class="fixed inset-0 z-[60] bg-black/80 flex flex-col items-center justify-center text-center p-4">
        <div class="loader mb-4 mx-auto" style="width: 40px; height: 40px;"></div>
        <p class="text-white">í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì„ ë¬¼ ì¤€ë¹„ ì¤‘...</p>
    </div>

    <!-- Start Screen -->
    <div id="startScreen" class="w-full max-w-md text-center space-y-6 hidden relative">
        
        <!-- Decorative Merry Christmas Text (Top Left) -->
        <div class="absolute -top-8 -left-8 transform -rotate-12 z-10 pointer-events-none">
            <h2 class="xmas-font text-3xl text-red-500 drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)]" 
                style="-webkit-text-stroke: 1px #fff; font-weight: 700;">
                Merry<br><span class="pl-4 text-green-500">Christmas!</span>
            </h2>
        </div>

        <!-- Settings & Copyright -->
        <div class="absolute top-0 right-0 flex flex-col items-end gap-1 z-20">
            <button onclick="window.openConfigModal()" class="p-1 text-gray-300 hover:text-white transition text-xs" title="ì„œë²„ ì„¤ì •">
                âš™ï¸ ì„¤ì •
            </button>
            <div class="text-[10px] text-gray-400/80 font-sans tracking-tight pr-1">
                Copyright: YeomT
            </div>
        </div>

        <h1 class="text-5xl text-white drop-shadow-lg mb-2 pt-12 font-bold relative z-0">
            ì´ëª¨ì§€ ê°•í™”í•˜ê¸°
        </h1>
        
        <!-- Connection Status & Server Select -->
        <div class="flex flex-col items-center gap-2 mb-2 relative z-10">
            <div id="connectionStatus" class="inline-block px-3 py-1 rounded-full text-xs font-bold bg-green-900/80 text-green-200 cursor-pointer hover:bg-green-800 transition border border-green-700">
                âšª ì˜¤í”„ë¼ì¸
            </div>
            
            <!-- Server Select Tabs -->
            <div id="serverSelector" class="hidden flex gap-4 text-sm font-bold bg-black/40 p-2 rounded-xl border border-red-900/50">
                <button onclick="window.switchServer('s1')" id="btn-s1" class="server-tab active px-2">1ì±„ë„</button>
                <button onclick="window.switchServer('s2')" id="btn-s2" class="server-tab px-2">2ì±„ë„</button>
                <button onclick="window.switchServer('s3')" id="btn-s3" class="server-tab px-2">3ì±„ë„</button>
            </div>
        </div>

        <p class="text-gray-300 text-lg relative z-10">0ë‹¨ê³„ ë¨¼ì§€ë¶€í„° 50ë‹¨ê³„ ìš°ì£¼ê¹Œì§€!</p>
        
        <div class="glass-panel p-6 space-y-4 border-t-4 border-red-600 relative z-10">
            <div class="text-6xl animate-bounce">ğŸ</div>
            <div class="text-sm text-gray-200 space-y-1">
                <p><span class="text-green-400 font-bold">Very Easy!</span> <span class="text-yellow-400 font-bold underline">5ë‹¨ê³„ë§ˆë‹¤</span> ë³´ì¡´ êµ¬ê°„ ì ìš©!</p>
                <p>ì—°ì† ì„±ê³µ ì‹œ <span class="text-red-400 font-bold">í”¼ë²„ íƒ€ì„</span> ë°œë™!</p>
            </div>
            <p class="text-sm text-gray-400">
                <span id="modeDesc">ë¡œì»¬ì— ê¸°ë¡ì´ ì €ì¥ë©ë‹ˆë‹¤.</span>
            </p>
            <input type="text" id="playerNameInput" placeholder="ë‹‰ë„¤ì„ (ìµœëŒ€ 8ê¸€ì)" maxlength="8" 
                class="w-full p-3 rounded-lg bg-black/50 border border-green-800 text-center text-xl text-white focus:outline-none focus:border-red-500 transition-colors placeholder-gray-500">
            <button onclick="window.startGame()" class="w-full bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-400 hover:to-yellow-500 text-black py-4 rounded-xl text-2xl font-bold shadow-lg hover:scale-105 transition-transform active:scale-95 border-b-4 border-yellow-800">
                â­ ë„ì „ ì‹œì‘!
            </button>
        </div>

        <div class="glass-panel p-4 relative border-t-2 border-green-600 z-10">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-xl text-green-300">ğŸ† <span id="rankTitle">ë¡œì»¬</span> ë­í‚¹</h3>
                <div class="flex items-center gap-1 text-xs text-gray-400">
                    <div id="statusDot" class="w-2 h-2 rounded-full bg-gray-500"></div> 
                    <span id="statusText">Local</span>
                </div>
            </div>
            <div id="startLeaderboardList" class="space-y-2 text-sm min-h-[100px]">
                <div class="text-gray-400 py-4">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="hidden w-full max-w-md flex flex-col items-center relative">
        <!-- Top Info -->
        <div class="w-full flex justify-between items-center mb-2 glass-panel p-3 px-5 border-b-2 border-green-700">
            <div class="text-gray-300">í”Œë ˆì´ì–´: <span id="displayPlayerName" class="text-white font-bold"></span></div>
            <div class="text-gray-300">í™•ë¥ : <span id="currentChance" class="text-green-400 font-bold">99%</span></div>
        </div>

        <!-- Fever Bar -->
        <div class="w-full h-2 bg-gray-900 rounded-full mb-4 overflow-hidden border border-gray-700 relative">
            <div id="feverBar" class="h-full bg-gradient-to-r from-red-500 to-yellow-400 transition-all duration-300" style="width: 0%"></div>
            <div id="feverText" class="absolute inset-0 text-[10px] flex items-center justify-center font-bold text-white hidden drop-shadow-md">ğŸ”¥ HOLIDAY FEVER ğŸ”¥</div>
        </div>

        <!-- Main Card -->
        <div id="cardArea" class="w-full bg-gradient-to-b from-gray-800 to-gray-900 rounded-3xl p-8 shadow-2xl border-4 border-green-800 text-center relative overflow-hidden mb-6 transition-colors duration-500">
            <!-- Safe Zone Indicator -->
            <div id="safeZoneIndicator" class="hidden absolute top-4 right-4 text-xs font-bold px-2 py-1 rounded border transition-colors">
                <!-- Text Injected by JS -->
            </div>

            <div class="absolute top-0 left-0 w-full h-2 bg-gray-700">
                <div id="progressBar" class="h-full bg-red-500 transition-all duration-500" style="width: 0%"></div>
            </div>
            
            <div class="mt-4 mb-2 text-gray-400 font-bold tracking-widest text-sm">LEVEL <span id="levelDisplay" class="text-2xl text-white">0</span></div>
            
            <div id="emojiDisplay" class="emoji-display text-[120px] leading-tight my-4 drop-shadow-2xl select-none">
                â˜ï¸
            </div>
            
            <div id="nameDisplay" class="text-3xl font-bold text-white mb-2 drop-shadow-md">ë¨¼ì§€</div>
            <div id="descDisplay" class="text-sm text-gray-500">ì•„ë¬´ëŸ° ê°€ì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>

        <!-- Control Buttons -->
        <div class="w-full grid grid-cols-2 gap-4">
            <button onclick="window.stopGame()" class="bg-gray-700 hover:bg-gray-600 text-gray-200 py-4 rounded-2xl font-bold text-xl shadow-lg transform transition active:scale-95 border-b-4 border-gray-900">
                âœ‹ ë©ˆì¶”ê¸°<br><span class="text-xs font-normal text-gray-400">ê¸°ë¡ ì €ì¥</span>
            </button>
            <button id="upgradeBtn" onclick="window.attemptUpgrade()" class="bg-gradient-to-b from-red-600 to-red-800 hover:from-red-500 hover:to-red-700 text-white py-4 rounded-2xl font-bold text-xl shadow-lg transform transition active:scale-95 border-b-4 border-red-900 relative overflow-hidden">
                <span class="relative z-10">ğŸ”¨ ê°•í™”í•˜ê¸°</span>
            </button>
        </div>

        <div id="gameLog" class="w-full mt-6 h-32 overflow-y-auto text-sm text-gray-400 space-y-1 p-2 scrollbar-hide text-center font-sans opacity-70">
            <div class="italic">ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="resultModal" class="hidden fixed inset-0 modal-bg flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 border-2 border-red-700 w-full max-w-sm rounded-2xl p-6 text-center shadow-2xl transform scale-100 transition-transform">
            <div id="resultIcon" class="text-6xl mb-4">ğŸ’¥</div>
            <h2 id="resultTitle" class="text-3xl font-bold mb-2 text-white">ê°•í™” ì‹¤íŒ¨!</h2>
            <p id="resultDesc" class="text-gray-300 mb-6">ì•„ì‰½ê²Œë„ ì•„ì´í…œì´ íŒŒê´´ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            
            <div class="bg-gray-900 rounded-lg p-4 mb-6 border border-gray-700">
                <div class="flex justify-between text-sm text-gray-400 mb-1">
                    <span>ìµœì¢… ë ˆë²¨</span>
                    <span>ê¸°ë¡ ì €ì¥</span>
                </div>
                <div class="flex justify-between items-end">
                    <span id="resultLevel" class="text-2xl text-yellow-400 font-bold">Lv. 12</span>
                    <span id="resultSaved" class="text-red-400 font-bold">ì‹¤íŒ¨ (ì €ì¥ ì•ˆë¨)</span>
                </div>
            </div>

            <button onclick="window.resetGame()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold text-lg hover:bg-green-500 transition shadow-lg">
                ë‹¤ì‹œ ë„ì „í•˜ê¸°
            </button>
        </div>
    </div>

    <!-- Config Modal -->
    <div id="configModal" class="hidden fixed inset-0 modal-bg flex items-center justify-center z-[70] p-4">
        <div class="bg-gray-800 border-2 border-gray-600 w-full max-w-md rounded-2xl p-6 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-4">âš™ï¸ Firebase ì„œë²„ ì„¤ì •</h2>
            <p class="text-sm text-gray-400 mb-4">
                í˜„ì¬ íŒŒì¼ ë‚´ë¶€ì— <b>ê³ ì •ëœ ì„œë²„ ì„¤ì •</b>ì´ ì ìš©ë˜ì–´ ìˆìŠµë‹ˆë‹¤.<br>
                <span class="text-green-400">ë³„ë„ì˜ ì„¤ì • ì—†ì´ ë°”ë¡œ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</span>
            </p>
            <textarea id="configInput" rows="6" class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-xs text-gray-300 font-mono mb-4" placeholder='{ "apiKey": "...", "authDomain": "...", ... }' disabled></textarea>
            <div class="flex gap-2">
                <button onclick="document.getElementById('configModal').classList.add('hidden')" class="w-full bg-gray-700 hover:bg-gray-600 text-white py-2 rounded font-bold">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- Leaderboard Modal (In Game) -->
    <div id="leaderboardSection" class="hidden w-full max-w-md mt-10">
        <div class="glass-panel p-5">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-yellow-400">ğŸ† <span id="ingameRankTitle">ë¡œì»¬</span> ë­í‚¹</h2>
                <span id="ingameStatus" class="text-xs text-gray-400">â— Local</span>
            </div>
            <div id="leaderboardList" class="space-y-3"></div>
        </div>
    </div>

    <!-- Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =========================================================================
        // [ì‚¬ìš©ì ì„œë²„ ì„¤ì • ì ìš©ë¨] - dsgames-fecef
        // =========================================================================
        const YOUR_FIREBASE_CONFIG = {
          apiKey: "AIzaSyBtK7NAfw4wDsS4LRacWF78PHT3zls50IQ",
          authDomain: "dsgames-fecef.firebaseapp.com",
          projectId: "dsgames-fecef",
          storageBucket: "dsgames-fecef.firebasestorage.app",
          messagingSenderId: "723943517090",
          appId: "1:723943517090:web:3e8596971cedf46cc460fb",
          measurementId: "G-GNVR6N4LKQ"
        };
        // =========================================================================

        // --- System State ---
        let isOnline = false;
        let db = null;
        let auth = null;
        let currentUser = null;
        let unsubscribeLeaderboard = null;
        
        let currentServer = 's1'; // s1, s2, s3
        const COLLECTIONS = {
            s1: 'emoji_rankings_v2_s1',
            s2: 'emoji_rankings_v2_s2',
            s3: 'emoji_rankings_v2_s3'
        };

        const CHECKPOINTS = [5, 10, 15, 20, 25, 30, 35, 40, 45];
        // Track consumed checkpoints (set of level numbers)
        let consumedCheckpoints = new Set();

        const LOCAL_STORAGE_KEY = 'emoji_upgrade_local_v2';
        const CONFIG_STORAGE_KEY = 'emoji_upgrade_firebase_config';
        const APP_ID = 'default-app-id'; 

        // Fever System
        let feverCount = 0;
        let feverActive = false;
        let feverTimer = null;
        const FEVER_THRESHOLD = 5; // Successes needed
        const FEVER_DURATION = 5000; // ms

        // --- Config UI Functions ---
        window.openConfigModal = function() {
            document.getElementById('configInput').value = JSON.stringify(YOUR_FIREBASE_CONFIG, null, 2);
            document.getElementById('configModal').classList.remove('hidden');
        }

        // --- Server Switch Logic ---
        window.switchServer = function(serverId) {
            if (!isOnline) {
                alert("ì˜¤í”„ë¼ì¸ ëª¨ë“œì—ì„œëŠ” ì±„ë„ì„ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            if (currentServer === serverId) return;

            currentServer = serverId;
            
            document.querySelectorAll('.server-tab').forEach(el => el.classList.remove('active'));
            document.getElementById(`btn-${serverId}`).classList.add('active');
            
            const serverName = serverId === 's1' ? '1ì±„ë„' : serverId === 's2' ? '2ì±„ë„' : '3ì±„ë„';
            const rankTitle = document.getElementById('rankTitle');
            const ingameRankTitle = document.getElementById('ingameRankTitle');
            if (rankTitle) rankTitle.innerText = serverName;
            if (ingameRankTitle) ingameRankTitle.innerText = serverName;

            listenToLeaderboard();
        }

        // --- Init Function ---
        async function initSystem() {
            try {
                let configToUse = YOUR_FIREBASE_CONFIG;
                let isHardcoded = true;

                if (!configToUse && typeof __firebase_config !== 'undefined' && __firebase_config) {
                    configToUse = JSON.parse(__firebase_config);
                    isHardcoded = false;
                }

                if (configToUse) {
                    const app = initializeApp(configToUse);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    
                    let authSuccess = false;
                    if (!isHardcoded && typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        try {
                            await signInWithCustomToken(auth, __initial_auth_token);
                            authSuccess = true;
                        } catch(e) { console.warn("Custom token failed", e); }
                    }

                    if (!authSuccess) {
                        await signInAnonymously(auth);
                    }
                    
                    currentUser = auth.currentUser;
                    isOnline = true;
                    
                    listenToLeaderboard();
                } else {
                    throw new Error("No Configuration Found");
                }
            } catch (error) {
                console.log("Switching to Offline Mode:", error.message);
                isOnline = false;
                
                const statusBadge = document.getElementById('connectionStatus');
                if(statusBadge) {
                    statusBadge.innerHTML = 'ğŸ”´ ì—°ê²° ì‹¤íŒ¨ (ì›ì¸ ë³´ê¸°)';
                    statusBadge.className = 'inline-block px-3 py-1 rounded-full text-xs font-bold bg-red-900 text-red-200 cursor-pointer hover:bg-red-800 transition mb-2';
                    statusBadge.onclick = () => {
                        alert("ì—°ê²° ì‹¤íŒ¨ ì›ì¸:\n" + error.message + "\n\n[í•´ê²° ë°©ë²•]\nFirebase Console -> Authentication -> Sign-in method -> ìµëª…(Anonymous) 'ì‚¬ìš© ì„¤ì •' ì¼œê¸°");
                    };
                }

                renderLocalLeaderboard();
            }

            updateModeUI();
            
            const loader = document.getElementById('serverLoading');
            if (loader) loader.classList.add('hidden');
            
            const startScreen = document.getElementById('startScreen');
            if (startScreen) startScreen.classList.remove('hidden');
        }

        function updateModeUI() {
            if (!isOnline) return;

            const statusBadge = document.getElementById('connectionStatus');
            const modeDesc = document.getElementById('modeDesc');
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const ingameStatus = document.getElementById('ingameStatus');
            const serverSelector = document.getElementById('serverSelector');
            const rankTitle = document.getElementById('rankTitle');

            if (isOnline) {
                if (statusBadge) {
                    statusBadge.innerHTML = 'ğŸŸ¢ ì˜¨ë¼ì¸ ëª¨ë“œ';
                    statusBadge.className = 'inline-block px-3 py-1 rounded-full text-xs font-bold bg-green-900/80 text-green-200 border border-green-700';
                    statusBadge.onclick = null;
                }
                if (modeDesc) modeDesc.innerText = "ì±„ë„ì„ ì„ íƒí•˜ì—¬ ë­í‚¹ì„ ê³µìœ í•˜ì„¸ìš”.";
                if (statusDot) statusDot.className = "w-2 h-2 rounded-full bg-green-500 animate-pulse";
                if (statusText) {
                    statusText.innerText = "Live";
                    statusText.className = "text-green-400";
                }
                if (ingameStatus) {
                    ingameStatus.innerText = "â— Live " + (currentServer === 's1' ? '1ì±„ë„' : currentServer === 's2' ? '2ì±„ë„' : '3ì±„ë„');
                    ingameStatus.className = "text-xs text-green-400";
                }
                
                if (serverSelector) serverSelector.classList.remove('hidden');
                if (rankTitle) rankTitle.innerText = "1ì±„ë„";
            }
        }

        // --- Leaderboard Logic ---
        function listenToLeaderboard() {
            if (!isOnline) {
                renderLocalLeaderboard();
                return;
            }

            if (unsubscribeLeaderboard) unsubscribeLeaderboard();

            const collectionName = COLLECTIONS[currentServer];
            const appId = typeof __app_id !== 'undefined' ? __app_id : APP_ID;
            
            const startList = document.getElementById('startLeaderboardList');
            if (startList) startList.innerHTML = '<div class="text-gray-400 py-4 text-center">ë°ì´í„° êµì²´ ì¤‘...</div>';
            
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', collectionName);
            
            unsubscribeLeaderboard = onSnapshot(colRef, (snapshot) => {
                const rankings = [];
                snapshot.forEach(doc => rankings.push(doc.data()));
                rankings.sort((a, b) => b.level - a.level);
                renderLeaderboardUI(rankings);
            }, (error) => {
                console.error("Fetch Error", error);
                if (startList) startList.innerHTML = '<div class="text-red-500 py-4 text-center">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>';
            });
        }

        function renderLocalLeaderboard() {
            const localData = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
            localData.sort((a, b) => b.level - a.level);
            renderLeaderboardUI(localData);
        }

        function renderLeaderboardUI(rankings) {
            [document.getElementById('startLeaderboardList'), document.getElementById('leaderboardList')].forEach(container => {
                if (!container) return;
                container.innerHTML = "";
                
                const displayList = rankings.slice(0, 10);
                if (displayList.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-2">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }

                displayList.forEach((rank, index) => {
                    const isTop = index < 3;
                    const rowClass = isTop ? 'bg-black/30 border-yellow-500/30' : 'bg-black/20 border-green-900';
                    const rankBadge = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}ìœ„`;
                    const isMe = rank.name === playerName;
                    const nameClass = isMe ? "text-yellow-300 font-bold" : "text-white font-bold";
                    
                    container.innerHTML += `
                        <div class="flex items-center justify-between p-2 rounded-lg border ${rowClass}">
                            <div class="flex items-center gap-3">
                                <span class="font-bold w-8 text-center text-yellow-500">${rankBadge}</span>
                                <div class="flex flex-col">
                                    <span class="${nameClass}">${rank.name}</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xl">${rank.emoji}</div>
                                <div class="text-xs text-yellow-300 font-bold">Lv.${rank.level} ${rank.item}</div>
                            </div>
                        </div>
                    `;
                });
            });
        }

        async function saveScore(level, name, item, emoji) {
            const data = {
                name, level, item, emoji,
                timestamp: Date.now()
            };

            if (isOnline && currentUser) {
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : APP_ID;
                    const collectionName = COLLECTIONS[currentServer];
                    const colRef = collection(db, 'artifacts', appId, 'public', 'data', collectionName);
                    await addDoc(colRef, { ...data, uid: currentUser.uid });
                    return true;
                } catch (e) {
                    console.error("Online save failed", e);
                }
            }

            const localData = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
            localData.push(data);
            localData.sort((a, b) => b.level - a.level);
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(localData.slice(0, 50))); 
            
            if (!isOnline) renderLocalLeaderboard();
            return true;
        }

        // --- Game Data & Logic ---
        const GAME_DATA = [
            { lv: 0, name: "ë¨¼ì§€", emoji: "ğŸŒ«ï¸", prob: 99, desc: "í›„~ ë¶ˆë©´ ë‚ ì•„ê°‘ë‹ˆë‹¤." },
            { lv: 1, name: "ëŒë§¹ì´", emoji: "ğŸª¨", prob: 98, desc: "ê¸¸ê°€ì— í”í•œ ëŒì…ë‹ˆë‹¤." },
            { lv: 2, name: "ì¡°ì•½ëŒ", emoji: "ğŸŒ‘", prob: 97, desc: "ì¡°ê¸ˆ ë§¤ë„ëŸ¬ì›Œì¡ŒìŠµë‹ˆë‹¤." },
            { lv: 3, name: "ë²½ëŒ", emoji: "ğŸ§±", prob: 96, desc: "ê±´ì¶• ìì¬ë¡œ ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤." },
            { lv: 4, name: "ë™ì „", emoji: "ğŸª™", prob: 95, desc: "ì§¤ë‘ì§¤ë‘ ì†Œë¦¬ê°€ ë‚©ë‹ˆë‹¤." },
            { lv: 5, name: "ë…¹ìŠ¨ ë‹¨ê²€", emoji: "ğŸ—¡ï¸", prob: 94, desc: "íŒŒìƒí’ì„ ì¡°ì‹¬í•˜ì„¸ìš”." },
            { lv: 6, name: "ë§ì¹˜", emoji: "ğŸ”¨", prob: 92, desc: "ëª»ì„ ë°•ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤." },
            { lv: 7, name: "ë„ë¼", emoji: "ğŸª“", prob: 90, desc: "ë‚˜ë¬´ë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." },
            { lv: 8, name: "ì² ê²€", emoji: "âš”ï¸", prob: 85, desc: "ê¸°ë³¸ì ì¸ ë¬´ê¸°ì…ë‹ˆë‹¤." },
            { lv: 9, name: "ë°©íŒ¨", emoji: "ğŸ›¡ï¸", prob: 80, desc: "ê³µê²©ì„ ë§‰ì•„ëƒ…ë‹ˆë‹¤." }, 
            // 10ë‹¨ê³„ ì´ìƒ í™•ë¥  3% ìƒí–¥
            { lv: 10, name: "ì€ìˆ˜ì €", emoji: "ğŸ¥„", prob: 78, desc: "ìš´ì´ ì¡°ê¸ˆ í•„ìš”í•©ë‹ˆë‹¤." },
            { lv: 11, name: "ê¸ˆë°˜ì§€", emoji: "ğŸ’", prob: 73, desc: "ë°˜ì§ì´ê¸° ì‹œì‘í•©ë‹ˆë‹¤." },
            { lv: 12, name: "ë£¨ë¹„", emoji: "ğŸ”´", prob: 68, desc: "ë¶‰ì€ ë¹›ì´ ì˜ë¡±í•©ë‹ˆë‹¤." },
            { lv: 13, name: "ì‚¬íŒŒì´ì–´", emoji: "ğŸ”µ", prob: 63, desc: "í‘¸ë¥¸ ë°”ë‹¤ì˜ ìƒ‰ì…ë‹ˆë‹¤." },
            { lv: 14, name: "ì—ë©”ë„ë“œ", emoji: "ğŸŸ¢", prob: 58, desc: "ìˆ²ì˜ ê¸°ìš´ì´ ëŠê»´ì§‘ë‹ˆë‹¤." },
            { lv: 15, name: "ë‹¤ì´ì•„ëª¬ë“œ", emoji: "ğŸ’", prob: 53, desc: "ê°€ì¥ ë‹¨ë‹¨í•œ ë³´ì„ì…ë‹ˆë‹¤." },
            { lv: 16, name: "ë³´ë¬¼ìƒì", emoji: "âš±ï¸", prob: 48, desc: "ë¬´ì—‡ì´ ë“¤ì—ˆì„ê¹Œìš”?" },
            { lv: 17, name: "ì™•ê´€", emoji: "ğŸ‘‘", prob: 43, desc: "ê¶Œë ¥ì˜ ìƒì§•ì…ë‹ˆë‹¤." },
            { lv: 18, name: "ë§ˆë²•ë´‰", emoji: "ğŸª„", prob: 38, desc: "ì‹ ë¹„í•œ í˜ì´ ê¹ƒë“¤ì—ˆìŠµë‹ˆë‹¤." },
            { lv: 19, name: "ìœ ë ¹", emoji: "ğŸ‘»", prob: 33, desc: "ì´ìŠ¹ì„ ë– ëŒê³  ìˆìŠµë‹ˆë‹¤." },
            { lv: 20, name: "ë„ê¹¨ë¹„ë¶ˆ", emoji: "ğŸ”¥", prob: 28, desc: "ëœ¨ê²ì§€ ì•Šì€ ë¶ˆê½ƒì…ë‹ˆë‹¤." },
            { lv: 21, name: "ìœ ë‹ˆì½˜", emoji: "ğŸ¦„", prob: 23, desc: "ì „ì„¤ ì†ì˜ ë™ë¬¼ì…ë‹ˆë‹¤." },
            { lv: 22, name: "ìš©", emoji: "ğŸ‰", prob: 21, desc: "í•˜ëŠ˜ì„ ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤." },
            { lv: 23, name: "ë¶ˆì‚¬ì¡°", emoji: "ğŸ¦…", prob: 19, desc: "ì£½ì§€ ì•ŠëŠ” ìƒˆì…ë‹ˆë‹¤." },
            { lv: 24, name: "ì²œì‚¬", emoji: "ğŸ‘¼", prob: 17, desc: "ì„±ìŠ¤ëŸ¬ìš´ ì¡´ì¬ì…ë‹ˆë‹¤." },
            { lv: 25, name: "ì•…ë§ˆ", emoji: "ğŸ˜ˆ", prob: 15, desc: "ìœ í˜¹ì„ ì¡°ì‹¬í•˜ì„¸ìš”." },
            { lv: 26, name: "ì™¸ê³„ì¸", emoji: "ğŸ‘½", prob: 14, desc: "ìš°ì£¼ì—ì„œ ì™”ìŠµë‹ˆë‹¤." },
            { lv: 27, name: "UFO", emoji: "ğŸ›¸", prob: 13, desc: "ë¯¸í™•ì¸ ë¹„í–‰ ë¬¼ì²´ì…ë‹ˆë‹¤." },
            { lv: 28, name: "ì¸ê³µìœ„ì„±", emoji: "ğŸ›°ï¸", prob: 12, desc: "ì§€êµ¬ë¥¼ ê°ì‹œí•©ë‹ˆë‹¤." },
            { lv: 29, name: "ë¡œì¼“", emoji: "ğŸš€", prob: 11, desc: "ëŒ€ê¸°ê¶Œì„ ëŒíŒŒí•©ë‹ˆë‹¤." },
            { lv: 30, name: "ë‹¬", emoji: "ğŸŒ™", prob: 10, desc: "í† ë¼ê°€ ì‚´ê³  ìˆìŠµë‹ˆë‹¤." },
            { lv: 31, name: "ì§€êµ¬", emoji: "ğŸŒ", prob: 9, desc: "ìš°ë¦¬ì˜ ê³ í–¥ì…ë‹ˆë‹¤." },
            { lv: 32, name: "íƒœì–‘", emoji: "â˜€ï¸", prob: 8, desc: "ëª¨ë“  ìƒëª…ì˜ ê·¼ì›ì…ë‹ˆë‹¤." },
            { lv: 33, name: "í˜œì„±", emoji: "â˜„ï¸", prob: 7, desc: "ê¼¬ë¦¬ê°€ ì•„ë¦„ë‹µìŠµë‹ˆë‹¤." },
            { lv: 34, name: "í† ì„±", emoji: "ğŸª", prob: 6, desc: "ì•„ë¦„ë‹¤ìš´ ê³ ë¦¬ë¥¼ ê°€ì¡ŒìŠµë‹ˆë‹¤." },
            { lv: 35, name: "ì€í•˜ìˆ˜", emoji: "ğŸŒŒ", prob: 5.5, desc: "ë³„ë“¤ì˜ ê°•ì…ë‹ˆë‹¤." },
            { lv: 36, name: "ë¸”ë™í™€", emoji: "âš«", prob: 5.0, desc: "ë¹›ì¡°ì°¨ ë¹ ì ¸ë‚˜ê°ˆ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." },
            { lv: 37, name: "ì´ˆì‹ ì„±", emoji: "ğŸ’¥", prob: 4.8, desc: "ë³„ì˜ ë§ˆì§€ë§‰ í­ë°œì…ë‹ˆë‹¤." },
            { lv: 38, name: "ì„±ìš´", emoji: "ğŸŒ«ï¸", prob: 4.6, desc: "ë³„ë“¤ì´ íƒœì–´ë‚˜ëŠ” ê³³ì…ë‹ˆë‹¤." },
            { lv: 39, name: "í€˜ì´ì‚¬", emoji: "âœ¨", prob: 4.4, desc: "ìš°ì£¼ì—ì„œ ê°€ì¥ ë°ì€ ì²œì²´ì…ë‹ˆë‹¤." },
            { lv: 40, name: "ì°¨ì›ì˜ ë¬¸", emoji: "ğŸšª", prob: 4.2, desc: "ì–´ë””ë¡œ ì—°ê²°ë ì§€ ëª¨ë¦…ë‹ˆë‹¤." },
            { lv: 41, name: "ì‹œê°„", emoji: "â³", prob: 4.0, desc: "ëˆ„êµ¬ë„ ê±°ìŠ¤ë¥¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." },
            { lv: 42, name: "ê³µê°„", emoji: "ğŸ’ ", prob: 3.8, desc: "ë¬´í•œíˆ í¼ì³ì ¸ ìˆìŠµë‹ˆë‹¤." },
            { lv: 43, name: "ë¹›", emoji: "ğŸ’¡", prob: 3.6, desc: "ê°€ì¥ ë¹ ë¥¸ ì¡´ì¬ì…ë‹ˆë‹¤." },
            { lv: 44, name: "ì–´ë‘ ", emoji: "ğŸŒ‘", prob: 3.5, desc: "ë¹›ì´ ì—†ëŠ” ê³³ì…ë‹ˆë‹¤." },
            { lv: 45, name: "í˜¼ëˆ", emoji: "ğŸŒ€", prob: 3.4, desc: "ì§ˆì„œê°€ ë¬´ë„ˆì§„ ìƒíƒœì…ë‹ˆë‹¤." },
            { lv: 46, name: "ì§ˆì„œ", emoji: "âš–ï¸", prob: 3.3, desc: "ëª¨ë“  ê²ƒì´ ì œìë¦¬ì— ìˆìŠµë‹ˆë‹¤." },
            { lv: 47, name: "ìƒëª…", emoji: "ğŸ§¬", prob: 3.2, desc: "ê¸°ì  ê·¸ ìì²´ì…ë‹ˆë‹¤." },
            { lv: 48, name: "ì£½ìŒ", emoji: "ğŸ’€", prob: 3.1, desc: "í”¼í•  ìˆ˜ ì—†ëŠ” ìš´ëª…ì…ë‹ˆë‹¤." },
            { lv: 49, name: "ì‹ ", emoji: "ğŸ›", prob: 3.05, desc: "ì „ì§€ì „ëŠ¥í•œ ì¡´ì¬ì…ë‹ˆë‹¤." },
            { lv: 50, name: "ìš°ì£¼ì˜ ì„­ë¦¬", emoji: "âš›ï¸", prob: 0, desc: "ì¡´ì¬í•˜ëŠ” ëª¨ë“  ê²ƒì˜ ì´ìœ ." }
        ];

        let currentLevel = 0;
        let playerName = "";
        let isProcessing = false;

        const els = {
            startScreen: document.getElementById('startScreen'),
            gameScreen: document.getElementById('gameScreen'),
            nameInput: document.getElementById('playerNameInput'),
            displayName: document.getElementById('displayPlayerName'),
            currentChance: document.getElementById('currentChance'),
            cardArea: document.getElementById('cardArea'),
            levelDisplay: document.getElementById('levelDisplay'),
            emojiDisplay: document.getElementById('emojiDisplay'),
            nameDisplay: document.getElementById('nameDisplay'),
            descDisplay: document.getElementById('descDisplay'),
            progressBar: document.getElementById('progressBar'),
            gameLog: document.getElementById('gameLog'),
            resultModal: document.getElementById('resultModal'),
            resultIcon: document.getElementById('resultIcon'),
            resultTitle: document.getElementById('resultTitle'),
            resultDesc: document.getElementById('resultDesc'),
            resultLevel: document.getElementById('resultLevel'),
            resultSaved: document.getElementById('resultSaved'),
            leaderboardSection: document.getElementById('leaderboardSection'),
            leaderboardList: document.getElementById('leaderboardList'),
            startLeaderboardList: document.getElementById('startLeaderboardList'),
            feverBar: document.getElementById('feverBar'),
            feverText: document.getElementById('feverText'),
            safeZoneIndicator: document.getElementById('safeZoneIndicator')
        };
        
        window.startGame = function() {
            const name = els.nameInput.value.trim();
            if (!name) {
                alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }
            playerName = name;
            currentLevel = 0;
            isProcessing = false;
            feverCount = 0;
            feverActive = false;
            consumedCheckpoints.clear(); // Reset used checkpoints
            
            updateUI();
            addLog("ê²Œì„ì„ ì‹œì‘í•©ë‹ˆë‹¤. í–‰ìš´ì„ ë¹•ë‹ˆë‹¤!");
            
            els.startScreen.classList.add('hidden');
            els.gameScreen.classList.remove('hidden');
            els.leaderboardSection.classList.remove('hidden');
        };

        window.attemptUpgrade = function() {
            if (isProcessing) return;
            if (currentLevel >= 50) return;

            isProcessing = true;
            const currentData = GAME_DATA[currentLevel];
            let prob = currentData.prob;

            // Fever Bonus
            if (feverActive) {
                prob = Math.min(prob + 5, 99); // Max 99
            }

            const btn = document.getElementById('upgradeBtn');
            btn.classList.add('scale-95', 'brightness-75');
            
            const probText = feverActive ? `${prob}% (FEVER +5%)` : `${prob}%`;
            addLog(`ê°•í™” ì‹œë„ ì¤‘... (í™•ë¥ : ${probText})`);

            // Speed up if fever
            const delay = feverActive ? 300 : 600;

            setTimeout(() => {
                btn.classList.remove('scale-95', 'brightness-75');
                const roll = Math.random() * 100;
                
                if (roll < prob) {
                    if (roll < (prob / 4)) success(3);
                    else if (roll < (prob / 2)) success(2);
                    else success(1);
                } else {
                    fail();
                }
                isProcessing = false;
            }, delay);
        };

        function success(increment) {
            // Fever Logic
            if (!feverActive) {
                feverCount++;
                const progress = Math.min((feverCount / FEVER_THRESHOLD) * 100, 100);
                els.feverBar.style.width = `${progress}%`;
                
                if (feverCount >= FEVER_THRESHOLD) {
                    activateFever();
                }
            }

            const prevLevel = currentLevel;
            currentLevel = Math.min(currentLevel + increment, 50);
            const actualIncrement = currentLevel - prevLevel;
            const data = GAME_DATA[currentLevel];
            
            if (increment === 3 && actualIncrement >= 3) {
                addLog(`âš¡ ì´ˆëŒ€ë°• í¬ë¦¬í‹°ì»¬!!! +3ë‹¨ê³„ ìƒìŠ¹!`);
                showFloatingText("âš¡ ì´ˆëŒ€ë°• +3 âš¡", "#d946ef");
                triggerEffect('animate-super-critical');
                fireConfetti(true);
            } else if (increment === 2 && actualIncrement >= 2) {
                addLog(`ğŸ”¥ í¬ë¦¬í‹°ì»¬! +2ë‹¨ê³„ ìƒìŠ¹!`);
                showFloatingText("ğŸ”¥ í¬ë¦¬í‹°ì»¬ +2 ğŸ”¥", "#fbbf24");
                triggerEffect('animate-critical');
                fireConfetti(false);
            } else {
                addLog(`âœ… ê°•í™” ì„±ê³µ! ${data.name}(ìœ¼)ë¡œ ì§„í™”!`);
                triggerEffect('animate-flash');
            }
            
            if (increment === 1 && (currentLevel % 5 === 0 || currentLevel > 30)) {
                fireConfetti(false);
            }

            updateUI();
            if (currentLevel === 50) window.stopGame(true);
        }

        function fail() {
            // Reset Fever
            feverCount = 0;
            if (!feverActive) els.feverBar.style.width = '0%';

            // 1. Lucky Revive (5% chance)
            const luckyRoll = Math.random() * 100;
            if (luckyRoll < 5) {
                addLog(`ğŸ˜‡ ì²œì‚¬ê°€ ì•„ì´í…œì„ ë³´í˜¸í–ˆìŠµë‹ˆë‹¤! (íŒŒê´´ ë°©ì–´)`);
                showFloatingText("ğŸ˜‡ ê¸°ì ì˜ ë¶€í™œ!", "#60a5fa");
                triggerEffect('animate-flash');
                return;
            }

            // 2. Checkpoints Logic (One-time Use)
            let savedLevel = 0;
            for (let cp of CHECKPOINTS) {
                if (currentLevel >= cp) {
                    savedLevel = cp;
                }
            }

            // Check if savedLevel exists and hasn't been consumed
            if (savedLevel > 0 && !consumedCheckpoints.has(savedLevel)) {
                consumedCheckpoints.add(savedLevel); // Mark as consumed
                currentLevel = savedLevel;
                const data = GAME_DATA[currentLevel];
                addLog(`ğŸ›¡ï¸ ê°•í™” ì‹¤íŒ¨... ${savedLevel}ë‹¨ê³„ì—ì„œ ë³´ì¡´ë˜ì—ˆìŠµë‹ˆë‹¤. (ë³´ì¡´ê¶Œ ì†Œë©¸)`);
                showFloatingText(`ğŸ›¡ï¸ ${savedLevel}ë‹¨ê³„ ë³´ì¡´ (ì‚¬ìš©ë¨)`, "#4ade80");
                triggerEffect('animate-shake');
                updateUI();
            } else {
                addLog(`ğŸ’¥ ê°•í™” ì‹¤íŒ¨... ì•„ì´í…œì´ íŒŒê´´ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                showFloatingText("íŒŒê´´ë¨...", "#ef4444");
                triggerEffect('animate-shake');
                showResult(false);
            }
        }

        function activateFever() {
            feverActive = true;
            els.feverText.classList.remove('hidden');
            els.cardArea.classList.add('fever-active');
            addLog(`ğŸ”¥ í”¼ë²„ íƒ€ì„ ë°œë™! í™•ë¥  +5% (5ì´ˆê°„)`);
            
            if (feverTimer) clearTimeout(feverTimer);
            feverTimer = setTimeout(() => {
                feverActive = false;
                feverCount = 0;
                els.feverBar.style.width = '0%';
                els.feverText.classList.add('hidden');
                els.cardArea.classList.remove('fever-active');
                addLog(`â„ï¸ í”¼ë²„ íƒ€ì„ ì¢…ë£Œ`);
                updateUI(); // Reset probability display
            }, FEVER_DURATION);
        }

        function showFloatingText(text, color) {
            const el = document.createElement('div');
            el.className = 'floating-text text-4xl drop-shadow-lg';
            el.innerText = text;
            el.style.color = color;
            els.cardArea.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function triggerEffect(animClass) {
            els.cardArea.classList.remove('animate-flash', 'animate-critical', 'animate-super-critical', 'animate-shake');
            void els.cardArea.offsetWidth;
            els.cardArea.classList.add(animClass);
        }

        window.stopGame = function(isClear = false) {
            if (isProcessing && !isClear) return;
            if (currentLevel === 0 && !isClear) {
                alert("0ë‹¨ê³„ì—ì„œëŠ” ë©ˆì¶œ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            saveScore(currentLevel, playerName, GAME_DATA[currentLevel].name, GAME_DATA[currentLevel].emoji)
                .then(() => showResult(true, isClear));
        };

        function showResult(isSaved, isClear = false) {
            els.resultModal.classList.remove('hidden');
            if (isSaved) {
                els.resultIcon.innerText = isClear ? "ğŸ‰" : "ğŸ›‘";
                els.resultTitle.innerText = isClear ? "ê²Œì„ í´ë¦¬ì–´!" : "ê°•í™” ì¤‘ë‹¨";
                els.resultDesc.innerText = isClear ? "ì „ì„¤ì ì¸ ì—…ì ì„ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤!" : "ì•ˆì „í•˜ê²Œ ì•„ì´í…œì„ ì±™ê²¼ìŠµë‹ˆë‹¤.";
                els.resultLevel.innerText = `Lv. ${currentLevel}`;
                els.resultLevel.className = "text-2xl text-green-400 font-bold";
                els.resultSaved.innerText = isOnline ? "ì„œë²„ ì €ì¥ ì™„ë£Œ" : "ë¡œì»¬ ì €ì¥ ì™„ë£Œ";
                els.resultSaved.className = "text-green-400 font-bold";
                if (isClear) fireConfetti(true);
            } else {
                els.resultIcon.innerText = "ğŸ’¥";
                els.resultTitle.innerText = "ê°•í™” ì‹¤íŒ¨";
                els.resultDesc.innerText = "ìš•ì‹¬ì´ ê³¼í–ˆìŠµë‹ˆë‹¤.";
                els.resultLevel.innerText = `(ë„ë‹¬) Lv. ${currentLevel}`;
                els.resultLevel.className = "text-2xl text-gray-500 font-bold";
                els.resultSaved.innerText = "ì €ì¥ ë¶ˆê°€";
                els.resultSaved.className = "text-red-400 font-bold";
            }
        }

        window.resetGame = function() {
            els.resultModal.classList.add('hidden');
            els.gameScreen.classList.add('hidden');
            els.leaderboardSection.classList.add('hidden');
            els.startScreen.classList.remove('hidden');
            els.nameInput.value = "";
            els.gameLog.innerHTML = '<div class="italic">ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.</div>';
        };

        function updateUI() {
            const data = GAME_DATA[currentLevel];
            els.displayName.innerText = playerName;
            els.levelDisplay.innerText = currentLevel;
            els.emojiDisplay.innerText = data.emoji;
            els.nameDisplay.innerText = data.name;
            els.descDisplay.innerText = data.desc;
            
            // Calc probability
            let prob = data.prob; 
            if (feverActive) prob = Math.min(prob + 5, 99);

            if (currentLevel < 50) {
                els.currentChance.innerText = feverActive ? `${prob}% (FEVER)` : `${prob}%`;
                els.currentChance.className = getProbColor(prob);
            } else {
                els.currentChance.innerText = "-";
            }
            const progress = (currentLevel / 50) * 100;
            els.progressBar.style.width = `${progress}%`;

            // Safe Zone Indicator Update
            // Logic: Is there a reachable checkpoint below or at current level?
            let currentCheckpoint = 0;
            for (let cp of CHECKPOINTS) {
                if (currentLevel >= cp) currentCheckpoint = cp;
            }

            if (currentCheckpoint > 0) {
                els.safeZoneIndicator.classList.remove('hidden');
                if (consumedCheckpoints.has(currentCheckpoint)) {
                    // Checkpoint used
                    els.safeZoneIndicator.innerHTML = `âš ï¸ ${currentCheckpoint}ë‹¨ê³„ ë³´ì¡´ ë¶ˆê°€ (ì‚¬ìš©ë¨)`;
                    els.safeZoneIndicator.className = "absolute top-4 right-4 text-xs font-bold bg-red-900/80 text-red-400 px-2 py-1 rounded border border-red-700 transition-colors";
                } else {
                    // Checkpoint available
                    els.safeZoneIndicator.innerHTML = `ğŸ›¡ï¸ ${currentCheckpoint}ë‹¨ê³„ ë³´ì¡´ ê°€ëŠ¥`;
                    els.safeZoneIndicator.className = "absolute top-4 right-4 text-xs font-bold bg-green-900/80 text-green-400 px-2 py-1 rounded border border-green-600 transition-colors";
                }
            } else {
                els.safeZoneIndicator.classList.add('hidden');
            }
        }

        function addLog(msg) {
            const div = document.createElement('div');
            div.innerText = msg;
            els.gameLog.prepend(div);
        }

        function getProbColor(prob) {
            if (prob >= 80) return "text-green-400 font-bold";
            if (prob >= 50) return "text-yellow-400 font-bold";
            if (prob >= 20) return "text-orange-500 font-bold";
            return "text-red-600 font-bold animate-pulse";
        }

        function fireConfetti(isMassive = false) {
            if (isMassive) {
                const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 999 };
                const random = (min, max) => Math.random() * (max - min) + min;
                confetti({ ...defaults, particleCount: 50, origin: { x: random(0.1, 0.3), y: Math.random() - 0.2 } });
                confetti({ ...defaults, particleCount: 50, origin: { x: random(0.7, 0.9), y: Math.random() - 0.2 } });
            } else {
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            }
        }

        // Start Init on DOMContentLoaded
        window.addEventListener('DOMContentLoaded', initSystem);
    </script>
</body>
</html>
